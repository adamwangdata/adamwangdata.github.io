
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

    <title>Time Series Reconstruction &#8212; Adam Wang&#39;s Data Science Portfolio</title>
    
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">
<link href="../_static/styles/pydata-sphinx-theme.css?digest=1999514e3f237ded88cf" rel="stylesheet">

    
  <link rel="stylesheet"
    href="../_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="../_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=5115cc725059bd94278eecd172e13a965bf8f5a9" type="text/css" />
    <link rel="stylesheet" type="text/css" href="../_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="../_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="../_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.b7bb847fb20b106c3d81b95245e65545.min.css" />
    
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf">

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/jquery.js"></script>
    <script src="../_static/underscore.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/clipboard.min.js"></script>
    <script src="../_static/copybutton.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=9c920249402e914e316237a7dbc6769907cce411"></script>
    <script>let toggleHintShow = 'Click to show';</script>
    <script>let toggleHintHide = 'Click to hide';</script>
    <script>let toggleOpenOnPrint = 'true';</script>
    <script src="../_static/togglebutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="../_static/design-tabs.js"></script>
    <script>const THEBE_JS_URL = "https://unpkg.com/thebe@0.8.2/lib/index.js"
const thebe_selector = ".thebe,.cell"
const thebe_selector_input = "pre"
const thebe_selector_output = ".output, .cell_output"
</script>
    <script async="async" src="../_static/sphinx-thebe.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script src="https://unpkg.com/@jupyter-widgets/html-manager@^0.20.1/dist/embed-amd.js"></script>
    <script>window.MathJax = {"tex": {"macros": {"parens": ["\\mathopen{}\\left(#1\\right)\\mathclose{}", 1], "bracks": ["\\mathopen{}\\left[#1\\right]\\mathclose{}", 1], "braces": ["\\mathopen{}\\left\\{#1\\right\\}\\mathclose{}", 1], "abs": ["\\mathopen{}\\left\\lvert#1\\right\\rvert\\mathclose{}", 1], "norm": ["\\mathopen{}\\left\\lVert#1\\right\\rVert\\mathclose{}", 1], "vec": ["\\boldsymbol{\\mathbf{#1}}", 1], "mat": ["\\mathbf{#1}", 1], "tpose": ["#1^T", 1], "inv": ["#1^{-1}", 1], "Matrix": ["\\begin{bmatrix}#1\\end{bmatrix}", 1], "seq": ["1, 2, \\ldots, #1", 1], "reals": ["\\mathbb{R}"], "mper": ["\\,\\text{.}"], "mcom": ["\\,\\text{,}"]}}, "options": {"processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="More Examples and Learning Resources" href="resources.html" />
    <link rel="prev" title="Time Series Forecasting" href="forecast.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="60">
<!-- Checkboxes to toggle the left sidebar -->
<input type="checkbox" class="sidebar-toggle" name="__navigation" id="__navigation" aria-label="Toggle navigation sidebar">
<label class="overlay overlay-navbar" for="__navigation">
    <div class="visually-hidden">Toggle navigation sidebar</div>
</label>
<!-- Checkboxes to toggle the in-page toc -->
<input type="checkbox" class="sidebar-toggle" name="__page-toc" id="__page-toc" aria-label="Toggle in-page Table of Contents">
<label class="overlay overlay-pagetoc" for="__page-toc">
    <div class="visually-hidden">Toggle in-page Table of Contents</div>
</label>
<!-- Headers at the top -->
<div class="announcement header-item noprint"></div>
<div class="header header-item noprint"></div>

    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<!-- Sidebar -->
<div class="bd-sidebar noprint" id="site-navigation">
    <div class="bd-sidebar__content">
        <div class="bd-sidebar__top"><div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="../index.html">
      
      
      
      <h1 class="site-logo" id="site-title">Adam Wang's Data Science Portfolio</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="../search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        
        <ul class="nav bd-sidenav bd-sidenav__home-link">
            <li class="toctree-l1">
                <a class="reference internal" href="../preface.html">
                    Preface
                </a>
            </li>
        </ul>
        <p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Deploying Models
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../deploy/churn.html">
   Predicting Churn with Amazon SageMaker
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Statistics and Machine Learning
 </span>
</p>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="ff_yelp.html">
   Farmer’s Fridge Yelp Reviews Analysis
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="forecast.html">
   Time Series Forecasting
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   Time Series Reconstruction
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="resources.html">
   More Examples and Learning Resources
  </a>
 </li>
</ul>
<p aria-level="2" class="caption" role="heading">
 <span class="caption-text">
  Python
 </span>
</p>
<ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="../python/euler.html">
   Project Euler
  </a>
 </li>
</ul>

    </div>
</nav></div>
        <div class="bd-sidebar__bottom">
             <!-- To handle the deprecated key -->
            
            <div class="navbar_extra_footer">
            Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
            </div>
            
        </div>
    </div>
    <div id="rtd-footer-container"></div>
</div>


          


          
<!-- A tiny helper pixel to detect if we've scrolled -->
<div class="sbt-scroll-pixel-helper"></div>
<!-- Main content -->
<div class="col py-0 content-container">
    
    <div class="header-article row sticky-top noprint">
        



<div class="col py-1 d-flex header-article-main">
    <div class="header-article__left">
        
        <label for="__navigation"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="right"
title="Toggle navigation"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-bars"></i>
  </span>

</label>

        
    </div>
    <div class="header-article__right">
<div class="menu-dropdown menu-dropdown-launch-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Launch interactive content">
      <i class="fas fa-rocket"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        
<button onclick="initThebeSBT()"
  class="headerbtn headerbtn-launch-thebe"
  data-toggle="tooltip"
data-placement="left"
title="Launch Thebe"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-play"></i>
  </span>
<span class="headerbtn__text-container">Live Code</span>
</button>

      </li>
      
    </ul>
  </div>
</div>

<button onclick="toggleFullScreen()"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="bottom"
title="Fullscreen mode"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>

<div class="menu-dropdown menu-dropdown-download-buttons">
  <button class="headerbtn menu-dropdown__trigger"
      aria-label="Download this page">
      <i class="fas fa-download"></i>
  </button>
  <div class="menu-dropdown__content">
    <ul>
      <li>
        <a href="../_sources/stat-ml/reconstruct.r"
   class="headerbtn"
   data-toggle="tooltip"
data-placement="left"
title="Download source file"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="headerbtn__text-container">.r</span>
</a>

      </li>
      
      <li>
        
<button onclick="printPdf(this)"
  class="headerbtn"
  data-toggle="tooltip"
data-placement="left"
title="Print to PDF"
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="headerbtn__text-container">.pdf</span>
</button>

      </li>
      
    </ul>
  </div>
</div>
<label for="__page-toc"
  class="headerbtn headerbtn-page-toc"
  
>
  

<span class="headerbtn__icon-container">
  <i class="fas fa-list"></i>
  </span>

</label>

    </div>
</div>

<!-- Table of contents -->
<div class="col-md-3 bd-toc show noprint">
    <div class="tocsection onthispage pt-5 pb-3">
        <i class="fas fa-list"></i> Contents
    </div>
    <nav id="bd-toc-nav" aria-label="Page">
        <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-source">
   Data Source
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preliminaries">
   Preliminaries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-exploration">
   Data Exploration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-diagnostics-and-selection">
   Model Diagnostics and Selection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimizing-predictive-accuracy">
   Optimizing Predictive Accuracy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-predictions">
   Making Predictions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

    </nav>
</div>
    </div>
    <div class="article row">
        <div class="col pl-md-3 pl-lg-5 content-container">
            <!-- Table of contents that is only displayed when printing the page -->
            <div id="jb-print-docs-body" class="onlyprint">
                <h1>Time Series Reconstruction</h1>
                <!-- Table of contents -->
                <div id="print-main-content">
                    <div id="jb-print-toc">
                        
                        <div>
                            <h2> Contents </h2>
                        </div>
                        <nav aria-label="Page">
                            <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#summary">
   Summary
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-source">
   Data Source
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#preliminaries">
   Preliminaries
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#data-exploration">
   Data Exploration
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#model-diagnostics-and-selection">
   Model Diagnostics and Selection
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#optimizing-predictive-accuracy">
   Optimizing Predictive Accuracy
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#making-predictions">
   Making Predictions
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#conclusion">
   Conclusion
  </a>
 </li>
</ul>

                        </nav>
                    </div>
                </div>
            </div>
            <main id="main-content" role="main">
                
              <div>
                
  <section class="tex2jax_ignore mathjax_ignore" id="time-series-reconstruction">
<span id="reconstruct"></span><h1>Time Series Reconstruction<a class="headerlink" href="#time-series-reconstruction" title="Permalink to this headline">#</a></h1>
<section id="summary">
<h2>Summary<a class="headerlink" href="#summary" title="Permalink to this headline">#</a></h2>
<p>I built a model to predict annual average temperatures all the way back to 1000 AD using proxy data, like tree ring radii.
Though recorded temperature data is only available from 1850, proxy data is available much further back in time.
My model results in the following reconstruction:</p>
<p><img alt="forecast" src="../_images/reconstruct.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can run and modify the code on this page Jupyter Notebook style, but without leaving the page!
Hover over the <span class="fa fa-rocket"></span> launch button at the top of the page, then click the <span class="guilabel">Live Code</span> button.
Once you see “Launching from mybinder.org: ready”, you can run code cells.
Refresh the page to revert to the original view.</p>
</div>
</section>
<section id="data-source">
<h2>Data Source<a class="headerlink" href="#data-source" title="Permalink to this headline">#</a></h2>
<p>Data was obtained from the <code class="docutils literal notranslate"><span class="pre">faraway</span></code> package’s <code class="docutils literal notranslate"><span class="pre">globwarm</span></code> dataset.
It consists of average northern hemisphere temperature <code class="docutils literal notranslate"><span class="pre">nhtemp</span></code> from 1856 to 2000 and eight climate proxies from 1000 to 2000.
Proxy data include tree ring, ice score, and sea shell data from a variety of geographic regions.
The original data can be found at <a class="reference external" href="https://www.ncdc.noaa.gov/paleo-search/study/6271">https://www.ncdc.noaa.gov/paleo-search/study/6271</a>.</p>
</section>
<section id="preliminaries">
<h2>Preliminaries<a class="headerlink" href="#preliminaries" title="Permalink to this headline">#</a></h2>
<p>First, a few frequently used package imports:</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">faraway</span><span class="p">)</span> <span class="c1"># For data, sumary(), and vif()</span>
<span class="nf">library</span><span class="p">(</span><span class="n">ggplot2</span><span class="p">)</span> <span class="c1"># Plot multiple ggplots in a grid.</span>
<span class="nf">library</span><span class="p">(</span><span class="n">gridExtra</span><span class="p">)</span> <span class="c1"># Plot multiple ggplots in a grid.</span>
</pre></div>
</div>
</div>
</div>
<p>Next, a few functions that will be frequently used.
I prefer graphical summaries of a data frame over numerical summaries provided by summary().
<code class="docutils literal notranslate"><span class="pre">summary_plot()</span></code> a dataframe and plots each predictor: barplots for categorical data and histograms for continuous data;
<code class="docutils literal notranslate"><span class="pre">cond_num()</span></code> computes condition numbers from a model object.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">summary_plot</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">for </span><span class="p">(</span><span class="n">var</span> <span class="n">in</span> <span class="nf">names</span><span class="p">(</span><span class="n">df</span><span class="p">))</span> <span class="p">{</span>
    <span class="n">data</span> <span class="o">&lt;-</span> <span class="n">df</span><span class="p">[[</span><span class="n">var</span><span class="p">]]</span>
    <span class="nf">if </span><span class="p">(</span><span class="nf">is.factor</span><span class="p">(</span><span class="n">data</span><span class="p">))</span> <span class="p">{</span>
      <span class="nf">plot</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">var</span><span class="p">)</span>
    <span class="p">}</span> <span class="n">else</span> <span class="p">{</span>
      <span class="nf">hist</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">main</span> <span class="o">=</span> <span class="s">&quot;&quot;</span><span class="p">,</span> <span class="n">xlab</span> <span class="o">=</span> <span class="n">var</span><span class="p">)</span>
    <span class="p">}</span>
  <span class="p">}</span>
<span class="p">}</span>

<span class="n">cond_num</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">lmod</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">lmod</span><span class="p">)[,</span> <span class="m">-1</span><span class="p">]</span>
  <span class="n">e</span> <span class="o">&lt;-</span> <span class="nf">eigen</span><span class="p">(</span><span class="nf">t</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">X</span><span class="p">)</span>
  <span class="nf">return</span><span class="p">(</span><span class="nf">sqrt</span><span class="p">(</span><span class="n">e</span><span class="o">$</span><span class="n">values</span><span class="p">[</span><span class="m">1</span><span class="p">]</span> <span class="o">/</span> <span class="n">e</span><span class="o">$</span><span class="n">values</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Finally, the next function looks complex, but it just sets better default figure parameters that work well in a notebook setting.</p>
<div class="cell tag_hide-input docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">repr</span><span class="p">)</span>

<span class="c1">#&#39; Specify figure parameters</span>
<span class="c1">#&#39;</span>
<span class="c1">#&#39; Call this function before plots to set the figure dimensions and par()</span>
<span class="c1">#&#39; options (if applicable). Defaults are defined for 1- and 2- panel figures;</span>
<span class="c1">#&#39; for more complex figures, you should call repr and par() instead.</span>
<span class="c1">#&#39; Optionally customize the figure dimensions in a two-element vector</span>
<span class="c1">#&#39; `dim`, assumed to be a c(width, height) pair in inches.</span>
<span class="n">set_pars</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">dim</span> <span class="o">=</span> <span class="kc">NULL</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">if </span><span class="p">(</span><span class="n">panels</span> <span class="o">==</span> <span class="m">1</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">options</span><span class="p">(</span>
      <span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">3.25</span><span class="p">,</span>
      <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">2.25</span>
    <span class="p">)</span>
    <span class="nf">par</span><span class="p">(</span>
      <span class="n">mar</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2.5</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">.</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">.</span><span class="m">2</span><span class="p">,</span>
      <span class="n">mgp</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1.8</span><span class="p">,</span> <span class="n">.</span><span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
      <span class="n">ps</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span>
      <span class="n">cex</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
      <span class="n">cex.lab</span> <span class="o">=</span> <span class="m">1.05</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">if </span><span class="p">(</span><span class="n">panels</span> <span class="o">==</span> <span class="m">2</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">options</span><span class="p">(</span>
      <span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span>
      <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">2.25</span>
    <span class="p">)</span>
    <span class="nf">par</span><span class="p">(</span>
      <span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
      <span class="n">mar</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2.5</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">.</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">.</span><span class="m">2</span><span class="p">,</span>
      <span class="n">mgp</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1.8</span><span class="p">,</span> <span class="n">.</span><span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
      <span class="n">ps</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span>
      <span class="n">cex</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
      <span class="n">cex.lab</span> <span class="o">=</span> <span class="m">1.05</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">if </span><span class="p">(</span><span class="n">panels</span> <span class="o">==</span> <span class="m">4</span><span class="p">)</span> <span class="p">{</span>
    <span class="nf">options</span><span class="p">(</span>
      <span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span>
      <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">4.5</span>
    <span class="p">)</span>
    <span class="nf">par</span><span class="p">(</span>
      <span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2</span><span class="p">,</span> <span class="m">2</span><span class="p">),</span>
      <span class="n">mar</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">4</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">.</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">.</span><span class="m">2</span><span class="p">,</span>
      <span class="n">mgp</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1.8</span><span class="p">,</span> <span class="n">.</span><span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span>
      <span class="n">ps</span> <span class="o">=</span> <span class="m">10</span><span class="p">,</span>
      <span class="n">cex</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span>
      <span class="n">cex.lab</span> <span class="o">=</span> <span class="m">1.05</span>
    <span class="p">)</span>
  <span class="p">}</span>

  <span class="nf">if </span><span class="p">(</span><span class="o">!</span><span class="nf">is.null</span><span class="p">(</span><span class="n">dim</span><span class="p">))</span> <span class="p">{</span>
    <span class="nf">options</span><span class="p">(</span>
      <span class="n">repr.plot.width</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[</span><span class="m">1</span><span class="p">],</span>
      <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="n">dim</span><span class="p">[</span><span class="m">2</span><span class="p">]</span>
    <span class="p">)</span>
  <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</section>
<section id="data-exploration">
<span id="data-exploration-reconstruct"></span><h2>Data Exploration<a class="headerlink" href="#data-exploration" title="Permalink to this headline">#</a></h2>
<p>We wish to build a model that can predict <code class="docutils literal notranslate"><span class="pre">nhtemp</span></code> from the eight climate proxies because proxy data is available for years 1000-2000.
Since the model requires available responses for training, for most of my analysis I’ll use a subset of data where <code class="docutils literal notranslate"><span class="pre">nhtemp</span></code> is available.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">df</span> <span class="o">&lt;-</span> <span class="n">globwarm</span><span class="p">[</span><span class="o">!</span><span class="nf">is.na</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">),</span> <span class="p">]</span>
</pre></div>
</div>
</div>
</div>
<p>I’ll return to the full dataset for predictions once I’ve chosen the model.
Finally, I won’t include <code class="docutils literal notranslate"><span class="pre">year</span></code> as a predictor in the regression model as we are interested in past prediction dating back to 1000.
This would be a serious extrapolation in terms of time while the proxies are somewhat periodic, for example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">globwarm</span><span class="o">$</span><span class="n">wusa</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">globwarm</span><span class="o">$</span><span class="n">mongolia</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_11_0.png" src="../_images/reconstruct_11_0.png" />
</div>
</div>
<p>Note that this does not exclude the use of year in informing the model, e.g. model diagnostics.
A graphical summary of the response nhtemp and predictors is shown next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">options</span><span class="p">(</span><span class="n">repr.plot.width</span> <span class="o">=</span> <span class="m">6</span><span class="p">,</span> <span class="n">repr.plot.height</span> <span class="o">=</span> <span class="m">6</span><span class="p">)</span>
<span class="nf">par</span><span class="p">(</span><span class="n">mfrow</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">3</span><span class="p">,</span> <span class="m">3</span><span class="p">),</span> <span class="n">mar</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">2.5</span><span class="p">,</span> <span class="m">3</span><span class="p">,</span> <span class="m">0</span><span class="p">,</span> <span class="n">.</span><span class="m">1</span><span class="p">)</span> <span class="o">+</span> <span class="n">.</span><span class="m">2</span><span class="p">,</span> <span class="n">mgp</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">1.8</span><span class="p">,</span> <span class="n">.</span><span class="m">8</span><span class="p">,</span> <span class="m">0</span><span class="p">),</span> <span class="n">ps</span> <span class="o">=</span> <span class="m">10</span><span class="p">)</span>
<span class="nf">summary_plot</span><span class="p">(</span><span class="n">df</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">%in%</span> <span class="s">&quot;year&quot;</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_13_0.png" src="../_images/reconstruct_13_0.png" />
</div>
</div>
<p>Tree ring proxies <code class="docutils literal notranslate"><span class="pre">jasper</span></code>, <code class="docutils literal notranslate"><span class="pre">urals</span></code>, and <code class="docutils literal notranslate"><span class="pre">mongolia</span></code> are strongly skewed left.
<code class="docutils literal notranslate"><span class="pre">tornetrask</span></code>, another tree ring proxy, appears nearly uniform.
The other variables, including the response, are approximately symmetric and unimodal.
It is also worth considering relationships between variables.
I do this using Spearman’s rank correlation, which measures the strength of monotonic (but not necessarily linear) relationships.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">corrplot</span><span class="p">)</span> <span class="c1"># For corrplot()</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">5</span><span class="p">,</span> <span class="m">5</span><span class="p">))</span>
<span class="n">correlations</span> <span class="o">&lt;-</span> <span class="nf">cor</span><span class="p">(</span><span class="n">df</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">%in%</span> <span class="s">&quot;year&quot;</span><span class="p">)],</span> <span class="n">method</span> <span class="o">=</span> <span class="s">&quot;spearman&quot;</span><span class="p">)</span>
<span class="nf">corrplot</span><span class="p">(</span><span class="n">correlations</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_16_0.png" src="../_images/reconstruct_16_0.png" />
</div>
</div>
<p>A few variables have multiple strong correlations, e.g. <code class="docutils literal notranslate"><span class="pre">mongolia</span></code> and <code class="docutils literal notranslate"><span class="pre">urals</span></code>, so I may need to address collinearity later although it is less problematic for prediction.
There is little noise in the proxy data from year to year, so scatterplots of proxies exhibit interesting relationships over time even when there is little correlation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="n">plot1</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">jasper</span><span class="p">,</span> <span class="n">urals</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">year</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;corr =&quot;</span><span class="p">,</span> <span class="nf">round</span><span class="p">(</span><span class="n">correlations</span><span class="p">[</span><span class="s">&quot;jasper&quot;</span><span class="p">,</span> <span class="s">&quot;urals&quot;</span><span class="p">],</span> <span class="m">2</span><span class="p">)))</span>
<span class="n">plot2</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">mongolia</span><span class="p">,</span> <span class="n">tasman</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">year</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;corr =&quot;</span><span class="p">,</span> <span class="nf">round</span><span class="p">(</span><span class="n">correlations</span><span class="p">[</span><span class="s">&quot;mongolia&quot;</span><span class="p">,</span> <span class="s">&quot;tasman&quot;</span><span class="p">],</span> <span class="m">2</span><span class="p">)))</span>
<span class="nf">grid.arrange</span><span class="p">(</span><span class="n">plot1</span><span class="p">,</span> <span class="n">plot2</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_18_0.png" src="../_images/reconstruct_18_0.png" />
</div>
</div>
<p>Scatterplots of response against correlated proxies yield more familiar plots; indeed the response is more variable which is why we’re modeling it with a random error.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="n">plot1</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">tornetrask</span><span class="p">,</span> <span class="n">nhtemp</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">year</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;corr =&quot;</span><span class="p">,</span> <span class="nf">round</span><span class="p">(</span><span class="n">correlations</span><span class="p">[</span><span class="s">&quot;tornetrask&quot;</span><span class="p">,</span> <span class="s">&quot;nhtemp&quot;</span><span class="p">],</span> <span class="m">2</span><span class="p">)))</span>
<span class="n">plot2</span> <span class="o">&lt;-</span> <span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">mongolia</span><span class="p">,</span> <span class="n">nhtemp</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="n">year</span><span class="p">))</span> <span class="o">+</span>
  <span class="nf">ggtitle</span><span class="p">(</span><span class="nf">paste</span><span class="p">(</span><span class="s">&quot;corr =&quot;</span><span class="p">,</span> <span class="nf">round</span><span class="p">(</span><span class="n">correlations</span><span class="p">[</span><span class="s">&quot;mongolia&quot;</span><span class="p">,</span> <span class="s">&quot;nhtemp&quot;</span><span class="p">],</span> <span class="m">2</span><span class="p">)))</span>
<span class="nf">grid.arrange</span><span class="p">(</span><span class="n">plot1</span><span class="p">,</span> <span class="n">plot2</span><span class="p">,</span> <span class="n">ncol</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_20_0.png" src="../_images/reconstruct_20_0.png" />
</div>
</div>
<p>The left (right) plot exhibits a (non)linear trend. Because prediction is of primary interest, I will consider nonlinear transformations later.</p>
</section>
<section id="model-diagnostics-and-selection">
<h2>Model Diagnostics and Selection<a class="headerlink" href="#model-diagnostics-and-selection" title="Permalink to this headline">#</a></h2>
<p>For now, nothing is particularly alarming, so I’ll start with a simple model linear in all predictors.
Since we’re interested in past prediction, I’ll reserve 30% of the oldest data as a test set to select the best model, measured by RMSE, and build the model on the rest of the data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">n</span> <span class="o">&lt;-</span> <span class="nf">nrow</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
<span class="n">test</span> <span class="o">&lt;-</span> <span class="n">df</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="nf">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">.</span><span class="m">3</span><span class="p">),</span> <span class="p">]</span>
<span class="n">train</span> <span class="o">&lt;-</span> <span class="n">df</span><span class="p">[(</span><span class="nf">floor</span><span class="p">(</span><span class="n">n</span> <span class="o">*</span> <span class="n">.</span><span class="m">3</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span><span class="o">:</span><span class="n">n</span><span class="p">,</span> <span class="p">]</span>
<span class="n">lmod</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">nhtemp</span> <span class="o">~</span> <span class="n">.</span> <span class="o">-</span> <span class="n">year</span><span class="p">,</span> <span class="n">train</span><span class="p">)</span>
<span class="nf">sumary</span><span class="p">(</span><span class="n">lmod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>             Estimate Std. Error t value Pr(&gt;|t|)
(Intercept) -0.421128   0.139750 -3.0134 0.003328
wusa         0.149016   0.078883  1.8891 0.061997
jasper      -0.302376   0.108297 -2.7921 0.006356
westgreen   -0.034597   0.076258 -0.4537 0.651114
chesapeake  -0.024290   0.054720 -0.4439 0.658152
tornetrask   0.088663   0.053118  1.6692 0.098450
urals        0.493856   0.219341  2.2515 0.026706
mongolia     0.032372   0.070700  0.4579 0.648112
tasman       0.104790   0.054379  1.9270 0.057031

n = 102, p = 9, Residual SE = 0.18948, R-Squared = 0.42
</pre></div>
</div>
</div>
</div>
<p>The residual standard error is moderate: <span class="math notranslate nohighlight">\(2 \times RSE\)</span> is more than the interquartile range.
I’ll examine R’s default diagnostic plots next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lmod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_24_0.png" src="../_images/reconstruct_24_0.png" />
</div>
</div>
<ol class="simple">
<li><p><strong>Residuals vs Fitted.</strong> There is no obvious trend suggestive of poor model structure. There are a few large residuals, particularly the later years implying the model underestimates the latest data.</p></li>
<li><p><strong>Normal Q-Q.</strong> The right tail violates the normality assumption, which seem to be the latest data.</p></li>
<li><p><strong>Scale-Location.</strong> The residuals do not deviate much from the constant variance assumption.</p></li>
<li><p><strong>Residuals vs Leverage.</strong> The oldest points in the dataset, 1899 and 1900, have the highest leverage and influence, but not high enough for me to consider their removal.</p></li>
</ol>
<p>Aside from normality of errors, which is the least important assumption, the simple model looks OK.
One could argue the large residuals are problematic for past predictions; perhaps they are indicative of global warming in recent years, a small range of time with distinct behavior that my simple linear model cannot capture.
I’ll test this formally using leave-one-out Studentized residuals, which are approximately distributed as <span class="math notranslate nohighlight">\(\mathcal{T}(n−p−1)\)</span>, where <span class="math notranslate nohighlight">\(p\)</span> is the number of parameters.
Using a Bonferroni correction at the <span class="math notranslate nohighlight">\(\alpha=0.05\)</span> level,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">tresid</span> <span class="o">&lt;-</span> <span class="nf">rstudent</span><span class="p">(</span><span class="n">lmod</span><span class="p">)</span>
<span class="nf">which</span><span class="p">(</span><span class="nf">abs</span><span class="p">(</span><span class="n">tresid</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nf">abs</span><span class="p">(</span><span class="nf">qt</span><span class="p">(</span><span class="n">.</span><span class="m">05</span> <span class="o">/</span> <span class="n">n</span><span class="p">,</span> <span class="n">lmod</span><span class="o">$</span><span class="n">df.residual</span> <span class="o">-</span> <span class="m">1</span><span class="p">)))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><strong>1998:</strong> 100</div></div>
</div>
<p>only the largest residual is a statistical outlier.
Before I consider removing it, I’ll investigate a larger issue that is difficult to observe from the above four diagnostics: the independent errors assumption.
This assumption can be difficult to check in general, and often requires some domain knowledge.
Time series data is often correlated because variables don’t change instantaneously.
For instance, today’s temperature is correlated with tomorrow’s; dramatic swings in daily temperature are rare.
Unless the model perfectly predicts these seasonal correlations, I’d expect residuals to be correlated from year to year.
This is hard to see from the diagnostic plots because year has not yet informed our model, but can be seen in plots of residuals against year and <span class="math notranslate nohighlight">\(\widehat{\varepsilon}_{i+1}\)</span> against <span class="math notranslate nohighlight">\(\widehat{\varepsilon}_i\)</span>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">train</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">lmod</span><span class="o">$</span><span class="n">residuals</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">lmod</span><span class="o">$</span><span class="n">residuals</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)],</span> <span class="n">lmod</span><span class="o">$</span><span class="n">residuals</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">train</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_28_0.png" src="../_images/reconstruct_28_0.png" />
</div>
</div>
<p>To address the correlated errors, I’ll use generalized least squares (GLS) with an AR1 correlation structure.
Specifically, I’ll model the the errors as a linear 1-step lag:</p>
<div class="math notranslate nohighlight">
\[ \varepsilon_{i+1} = \phi \varepsilon_i + \delta_i \]</div>
<p>where <span class="math notranslate nohighlight">\(\delta_i \sim \mathcal{N}(0, \tau^2)\)</span>. The resultant covariance matrix of the errors has the form</p>
<div class="math notranslate nohighlight">
\[\begin{split}
  \boldsymbol{\Sigma} = \sigma^2 \Matrix{
    1 &amp; \phi &amp; \phi^2 &amp; \cdots &amp; \phi^n \\
      &amp; 1    &amp; \phi   &amp; \cdots &amp; \phi^{n-1} \\
      &amp;      &amp; 1   &amp; \cdots &amp; \phi^{n-2} \\
      &amp;      &amp;     &amp; \ddots &amp; \vdots \\
      &amp;      &amp;     &amp;  &amp; 1 \\
  }
\end{split}\]</div>
<p>We can then transform the response and design matrix to <span class="math notranslate nohighlight">\(\boldsymbol{y}'=\boldsymbol{S}^{-1} \boldsymbol{y}\)</span> and  and <span class="math notranslate nohighlight">\(\boldsymbol{X}'=\boldsymbol{S}^{-1}\boldsymbol{X}\)</span>, where <span class="math notranslate nohighlight">\(\boldsymbol{S}\)</span> is obtained from the Choleski decomposition <span class="math notranslate nohighlight">\(\boldsymbol{\Sigma}=\boldsymbol{S}\boldsymbol{S}^{T}\)</span>, and regress <span class="math notranslate nohighlight">\(\boldsymbol{y}'\)</span> on <span class="math notranslate nohighlight">\(\boldsymbol{X}'\)</span>:</p>
<div class="math notranslate nohighlight">
\[ \boldsymbol{y}' = \boldsymbol{X}'\boldsymbol{\beta} + \boldsymbol{\varepsilon}' \]</div>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p><span class="math notranslate nohighlight">\(^{\dagger}\)</span> There appear to be two estimated parameters in the AR1 covariance matrix: <span class="math notranslate nohighlight">\(\sigma\)</span> and <span class="math notranslate nohighlight">\(\phi\)</span>. However, we don’t actually need to specify <span class="math notranslate nohighlight">\(\sigma\)</span> for GLS to work. We only need to specify a covariance matrix proportional to <span class="math notranslate nohighlight">\(\boldsymbol{\Sigma}\)</span>; the constant  <span class="math notranslate nohighlight">\(\sigma^2\)</span> just amounts to a change in scale which is irrelevant in the transformed regression model.</p>
</aside>
<p>If <span class="math notranslate nohighlight">\(\boldsymbol{\Sigma}\)</span> is correctly specified, the transformed errors <span class="math notranslate nohighlight">\(\boldsymbol{\varepsilon}'=\boldsymbol{S}^{-1} \boldsymbol{\varepsilon}\)</span> are i.i.d.<span class="math notranslate nohighlight">\(^{\dagger}\)</span>
I’ll implement GLS using the nlme package.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">nlme</span><span class="p">)</span>
<span class="n">glmod</span> <span class="o">&lt;-</span> <span class="nf">gls</span><span class="p">(</span><span class="n">nhtemp</span> <span class="o">~</span> <span class="n">.</span> <span class="o">-</span> <span class="n">year</span><span class="p">,</span> <span class="n">correlation</span> <span class="o">=</span> <span class="nf">corAR1</span><span class="p">(</span><span class="n">form</span> <span class="o">=</span> <span class="o">~</span><span class="n">year</span><span class="p">),</span> <span class="n">train</span><span class="p">)</span>
<span class="nf">summary</span><span class="p">(</span><span class="n">glmod</span><span class="o">$</span><span class="n">modelStruct</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_plain highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Correlation Structure: AR(1)
 Formula: ~year 
 Parameter estimate(s):
     Phi 
0.856977 
</pre></div>
</div>
</div>
</div>
<p>We observe strong correlation between residuals. Let’s see how the coefficients change:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">summary</span><span class="p">(</span><span class="n">glmod</span><span class="p">)</span><span class="o">$</span><span class="n">tTable</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><table class="dataframe">
<caption>A matrix: 9 × 4 of type dbl</caption>
<thead>
	<tr><th></th><th scope=col>Value</th><th scope=col>Std.Error</th><th scope=col>t-value</th><th scope=col>p-value</th></tr>
</thead>
<tbody>
	<tr><th scope=row>(Intercept)</th><td>-0.18738021</td><td>0.3107210</td><td>-0.60304977</td><td>0.5479434</td></tr>
	<tr><th scope=row>wusa</th><td> 0.00769262</td><td>0.1829881</td><td> 0.04203891</td><td>0.9665578</td></tr>
	<tr><th scope=row>jasper</th><td>-0.17928669</td><td>0.3205254</td><td>-0.55935245</td><td>0.5772658</td></tr>
	<tr><th scope=row>westgreen</th><td> 0.06251127</td><td>0.1632877</td><td> 0.38282892</td><td>0.7027202</td></tr>
	<tr><th scope=row>chesapeake</th><td> 0.05893335</td><td>0.1242621</td><td> 0.47426633</td><td>0.6364217</td></tr>
	<tr><th scope=row>tornetrask</th><td> 0.01636588</td><td>0.1311168</td><td> 0.12481914</td><td>0.9009361</td></tr>
	<tr><th scope=row>urals</th><td> 0.36419117</td><td>0.5579029</td><td> 0.65278590</td><td>0.5155048</td></tr>
	<tr><th scope=row>mongolia</th><td> 0.02987473</td><td>0.2015126</td><td> 0.14825242</td><td>0.8824645</td></tr>
	<tr><th scope=row>tasman</th><td> 0.10277331</td><td>0.1545286</td><td> 0.66507626</td><td>0.5076477</td></tr>
</tbody>
</table>
</div></div>
</div>
<p>Point estimates change and there is substantially more uncertainty.
Remember, though, from a statistical standpoint this model should be better, e.g. its residuals should no longer be correlated.
<code class="docutils literal notranslate"><span class="pre">gls</span></code> objects do not have the four graphical diagnostics we are accustomed to.
I’ll implement GLS using <code class="docutils literal notranslate"><span class="pre">lm()</span></code> instead, with the help of other functions from <code class="docutils literal notranslate"><span class="pre">nlme</span></code> to specify the covariance structure <span class="math notranslate nohighlight">\(\boldsymbol{\Sigma}\)</span>  and transform the data accordingly, using the estimated <span class="math notranslate nohighlight">\(\phi\)</span> above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">Sigma</span> <span class="o">&lt;-</span> <span class="nf">corMatrix</span><span class="p">(</span><span class="n">glmod</span><span class="o">$</span><span class="n">modelStruct</span><span class="o">$</span><span class="n">corStruct</span><span class="p">)</span>
<span class="n">S</span> <span class="o">&lt;-</span> <span class="nf">t</span><span class="p">(</span><span class="nf">chol</span><span class="p">(</span><span class="n">Sigma</span><span class="p">))</span>
<span class="n">y</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">%*%</span> <span class="n">train</span><span class="o">$</span><span class="n">nhtemp</span> <span class="c1"># y&#39;</span>
<span class="n">X</span> <span class="o">&lt;-</span> <span class="nf">solve</span><span class="p">(</span><span class="n">S</span><span class="p">)</span> <span class="o">%*%</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">nhtemp</span> <span class="o">~</span> <span class="n">.</span> <span class="o">-</span> <span class="n">year</span><span class="p">,</span> <span class="n">train</span><span class="p">)</span> <span class="c1"># X&#39;</span>
<span class="nf">rownames</span><span class="p">(</span><span class="n">y</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">rownames</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">&lt;-</span> <span class="nf">rownames</span><span class="p">(</span><span class="n">train</span><span class="p">)</span>
<span class="n">glmod</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">y</span> <span class="o">~</span> <span class="n">X</span> <span class="o">+</span> <span class="m">0</span><span class="p">)</span>
<span class="nf">sumary</span><span class="p">(</span><span class="n">glmod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stream highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>               Estimate Std. Error t value Pr(&gt;|t|)
X(Intercept) -0.1873802  0.3107210 -0.6030   0.5479
Xwusa         0.0076926  0.1829881  0.0420   0.9666
Xjasper      -0.1792867  0.3205254 -0.5594   0.5773
Xwestgreen    0.0625113  0.1632877  0.3828   0.7027
Xchesapeake   0.0589333  0.1242621  0.4743   0.6364
Xtornetrask   0.0163659  0.1311168  0.1248   0.9009
Xurals        0.3641912  0.5579029  0.6528   0.5155
Xmongolia     0.0298747  0.2015126  0.1483   0.8825
Xtasman       0.1027733  0.1545286  0.6651   0.5076

n = 102, p = 9, Residual SE = 0.27744, R-Squared = 0.03
</pre></div>
</div>
</div>
</div>
<p>We’ve recovered the same GLS model using <code class="docutils literal notranslate"><span class="pre">lm()</span></code>. On to diagnostics, which appear substantially different:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">glmod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_36_0.png" src="../_images/reconstruct_36_0.png" />
</div>
</div>
<aside class="margin sidebar">
<p class="sidebar-title"></p>
<p><span class="math notranslate nohighlight">\(^{\dagger}\)</span> Removal leads to a model with substantial changes to estimates and errors. Prediction on the test set is substantially worse.</p>
</aside>
<p>1988 is no longer an outlier—in fact, no Studentized residual is statistically significant after Bonferroni correction at <span class="math notranslate nohighlight">\(\alpha=0.05\)</span>.
1899 is now a high leverage point point with large influence.
However, this is an artifact of the transformed design matrix <span class="math notranslate nohighlight">\(\boldsymbol{X}\)</span>’, whose first row is identical to <span class="math notranslate nohighlight">\(\boldsymbol{X}\)</span>. For this reason, I won’t remove this point.<span class="math notranslate nohighlight">\(^{\dagger}\)</span> The qqplot is improved, though still has a problematic right tail. The GLS model introduces heteroscedasticity, which I’ll address later. Importantly, residual plots no longer show correlation.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">train</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">glmod</span><span class="o">$</span><span class="n">residuals</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">glmod</span><span class="o">$</span><span class="n">residuals</span><span class="p">[</span><span class="m">1</span><span class="o">:</span><span class="p">(</span><span class="nf">nrow</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)],</span> <span class="n">glmod</span><span class="o">$</span><span class="n">residuals</span><span class="p">[</span><span class="m">2</span><span class="o">:</span><span class="nf">nrow</span><span class="p">(</span><span class="n">train</span><span class="p">)])</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_38_0.png" src="../_images/reconstruct_38_0.png" />
</div>
</div>
<p>To check the degree of collinearity, I examined the condition numbers. The largest was 11.75677, so I won’t take any special precautions.
We can’t address heteroscedasticity using a Box–Cox transformation of the response because some <span class="math notranslate nohighlight">\(y&lt;0\)</span>. Residuals plots against each predictor don’t suggest any predictor transformations. Instead, I’ll add another candidate model using weights. Since year and nhtemp are correlated and higher predicted nhtemp values have more variance, I’ll use some form of temporal weighting.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">4</span><span class="p">)</span>
<span class="n">wts</span> <span class="o">&lt;-</span> <span class="m">1</span> <span class="o">/</span> <span class="p">(</span><span class="nf">as.integer</span><span class="p">(</span><span class="nf">rownames</span><span class="p">(</span><span class="n">X</span><span class="p">))</span> <span class="o">-</span> <span class="nf">min</span><span class="p">(</span><span class="nf">as.integer</span><span class="p">(</span><span class="nf">rownames</span><span class="p">(</span><span class="n">X</span><span class="p">)))</span> <span class="o">+</span> <span class="m">1</span><span class="p">)</span><span class="o">**</span><span class="n">.</span><span class="m">5</span>
<span class="n">wglmod</span> <span class="o">&lt;-</span> <span class="nf">lm</span><span class="p">(</span><span class="n">y</span> <span class="o">~</span> <span class="n">X</span> <span class="o">+</span> <span class="m">0</span><span class="p">,</span> <span class="n">weights</span> <span class="o">=</span> <span class="n">wts</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">wglmod</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in sqrt(crit * p * (1 - hh)/hh):
“NaNs produced”
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message in sqrt(crit * p * (1 - hh)/hh):
“NaNs produced”
</pre></div>
</div>
<img alt="../_images/reconstruct_40_2.png" src="../_images/reconstruct_40_2.png" />
</div>
</div>
<p>The exact form of the weights was found by trial and error. The resultant weights span a large range; the oldest point is weighed more than 10 times the most recent point, which results in a larger Cook’s distance. I’ll see whether the weights help in prediction next, skipping variable selection since <span class="math notranslate nohighlight">\(n/p\)</span> is not too small and we’re focused on prediction.</p>
</section>
<section id="optimizing-predictive-accuracy">
<h2>Optimizing Predictive Accuracy<a class="headerlink" href="#optimizing-predictive-accuracy" title="Permalink to this headline">#</a></h2>
<p>I’ll grade models on the mean RMSE of their predictions for the test data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">get_rmse</span> <span class="o">&lt;-</span> <span class="nf">function</span><span class="p">(</span><span class="n">ypred</span><span class="p">,</span> <span class="n">yobs</span><span class="p">)</span> <span class="p">{</span>
  <span class="nf">sqrt</span><span class="p">(</span><span class="nf">mean</span><span class="p">((</span><span class="n">ypred</span> <span class="o">-</span> <span class="n">yobs</span><span class="p">)</span><span class="o">**</span><span class="m">2</span><span class="p">))</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<p>Since the GLS models were trained on transformed data, I’ll compute predictions using extracted model coefficients rather than the <code class="docutils literal notranslate"><span class="pre">predict()</span></code> method.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">X_test</span> <span class="o">&lt;-</span> <span class="nf">model.matrix</span><span class="p">(</span><span class="n">nhtemp</span> <span class="o">~</span> <span class="n">.</span> <span class="o">-</span> <span class="n">year</span><span class="p">,</span> <span class="n">test</span><span class="p">)</span>
<span class="nf">get_rmse</span><span class="p">(</span><span class="n">X_test</span> <span class="o">%*%</span> <span class="nf">coef</span><span class="p">(</span><span class="n">lmod</span><span class="p">),</span> <span class="n">test</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.304483407233523</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get_rmse</span><span class="p">(</span><span class="n">X_test</span> <span class="o">%*%</span> <span class="nf">coef</span><span class="p">(</span><span class="n">glmod</span><span class="p">),</span> <span class="n">test</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.164846471593732</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">get_rmse</span><span class="p">(</span><span class="n">X_test</span> <span class="o">%*%</span> <span class="nf">coef</span><span class="p">(</span><span class="n">wglmod</span><span class="p">),</span> <span class="n">test</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.226038487274372</div></div>
</div>
<p>The AR1 model without the additional weighting performs best. There is the possibility of improvement if we use shrinkage methods. I’ll employ ridge regression using the glmnet package, which allows us to flexibly shrink predictor coefficients; in particular, we can specify no penalty on the (transformed) intercept term in the GLS models.</p>
<div class="cell tag_remove-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">library</span><span class="p">(</span><span class="n">glmnet</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set.seed</span><span class="p">(</span><span class="m">1</span><span class="p">)</span> <span class="c1"># For reproducibility (from cross-validation).</span>
<span class="n">ridge_lmod</span> <span class="o">&lt;-</span> <span class="nf">cv.glmnet</span><span class="p">(</span>
  <span class="n">x</span> <span class="o">=</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="n">train</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">train</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;nhtemp&quot;</span><span class="p">,</span> <span class="s">&quot;year&quot;</span><span class="p">))]),</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">train</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="kc">TRUE</span>
<span class="p">)</span>
<span class="nf">get_rmse</span><span class="p">(</span><span class="n">X_test</span> <span class="o">%*%</span> <span class="nf">coef</span><span class="p">(</span><span class="n">ridge_lmod</span><span class="p">),</span> <span class="n">test</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.146752536024208</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ridge_glmod</span> <span class="o">&lt;-</span> <span class="nf">cv.glmnet</span><span class="p">(</span>
  <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
  <span class="n">alpha</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">penalty.factor</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">))</span>
<span class="p">)</span>
<span class="nf">get_rmse</span><span class="p">(</span><span class="n">X_test</span> <span class="o">%*%</span> <span class="nf">coef</span><span class="p">(</span><span class="n">ridge_glmod</span><span class="p">)[</span><span class="m">2</span><span class="o">:</span><span class="p">(</span><span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)],</span> <span class="n">test</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.274797277066109</div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ridge_wglmod</span> <span class="o">&lt;-</span> <span class="nf">cv.glmnet</span><span class="p">(</span>
  <span class="n">X</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span>
  <span class="n">alpha</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="kc">FALSE</span><span class="p">,</span> <span class="n">penalty.factor</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">0</span><span class="p">,</span> <span class="nf">rep</span><span class="p">(</span><span class="m">1</span><span class="p">,</span> <span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span><span class="p">)),</span>
  <span class="n">weights</span> <span class="o">=</span> <span class="n">wts</span>
<span class="p">)</span>
<span class="nf">get_rmse</span><span class="p">(</span><span class="n">X_test</span> <span class="o">%*%</span> <span class="nf">coef</span><span class="p">(</span><span class="n">ridge_wglmod</span><span class="p">)[</span><span class="m">2</span><span class="o">:</span><span class="p">(</span><span class="nf">ncol</span><span class="p">(</span><span class="n">X</span><span class="p">)</span> <span class="o">+</span> <span class="m">1</span><span class="p">)],</span> <span class="n">test</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html">0.184994049860009</div></div>
</div>
<p>Surprisingly, the linear model with ridge regression obtains the best accuracy among all models considered. Ridge regression doesn’t benefit the GLS models—inspection of the penalized coefficients show all terms but the intercept are shrunk to zero. I’ll continue with <code class="docutils literal notranslate"><span class="pre">glmod</span></code> and <code class="docutils literal notranslate"><span class="pre">ridge_lmod</span></code> to compare their predictions. If there are stark differences I’ll need to think harder on picking one model.</p>
</section>
<section id="making-predictions">
<h2>Making Predictions<a class="headerlink" href="#making-predictions" title="Permalink to this headline">#</a></h2>
<p>I’ll train the models on all data with available <code class="docutils literal notranslate"><span class="pre">nhtemp</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ridge_lmod</span> <span class="o">&lt;-</span> <span class="nf">cv.glmnet</span><span class="p">(</span>
  <span class="n">x</span> <span class="o">=</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="n">df</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;nhtemp&quot;</span><span class="p">,</span> <span class="s">&quot;year&quot;</span><span class="p">))]),</span>
  <span class="n">y</span> <span class="o">=</span> <span class="n">df</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">,</span> <span class="n">alpha</span> <span class="o">=</span> <span class="m">0</span><span class="p">,</span> <span class="n">intercept</span> <span class="o">=</span> <span class="kc">TRUE</span>
<span class="p">)</span>

<span class="n">glmod</span> <span class="o">&lt;-</span> <span class="nf">gls</span><span class="p">(</span><span class="n">nhtemp</span> <span class="o">~</span> <span class="n">.</span> <span class="o">-</span> <span class="n">year</span><span class="p">,</span> <span class="n">correlation</span> <span class="o">=</span> <span class="nf">corAR1</span><span class="p">(</span><span class="n">form</span> <span class="o">=</span> <span class="o">~</span><span class="n">year</span><span class="p">),</span> <span class="n">df</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<p>Prediction on all data are computed next.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="n">ridge_lmod_pred</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span>
  <span class="n">ridge_lmod</span><span class="p">,</span>
  <span class="n">newx</span> <span class="o">=</span> <span class="nf">as.matrix</span><span class="p">(</span><span class="n">globwarm</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">globwarm</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;nhtemp&quot;</span><span class="p">,</span> <span class="s">&quot;year&quot;</span><span class="p">))])</span>
<span class="p">)</span>
<span class="n">glmod_pred</span> <span class="o">&lt;-</span> <span class="nf">predict</span><span class="p">(</span><span class="n">glmod</span><span class="p">,</span> <span class="n">globwarm</span><span class="p">[,</span> <span class="o">!</span><span class="p">(</span><span class="nf">names</span><span class="p">(</span><span class="n">globwarm</span><span class="p">)</span> <span class="o">%in%</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;nhtemp&quot;</span><span class="p">))])</span>
</pre></div>
</div>
</div>
</div>
<p>I think it’s instructive to first plot the fits on the subset of fully available data.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">panels</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">df</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">df</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">ridge_lmod_pred</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">glmod_pred</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="m">3</span><span class="p">,</span> <span class="n">lty</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;ridge&quot;</span><span class="p">,</span> <span class="s">&quot;GLS&quot;</span><span class="p">),</span> <span class="n">lty</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_57_0.png" src="../_images/reconstruct_57_0.png" />
</div>
</div>
<p>The GLS model better captures temporal variation, while the ridge model hovers around the mean temperature -0.12034. This feature is even more pronounced when we predict back to year 1000, leading to drastically different predictions.</p>
<div class="cell tag_full-width docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">8</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>
<span class="nf">plot</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">globwarm</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">ridge_lmod_pred</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="m">2</span><span class="p">)</span>
<span class="nf">lines</span><span class="p">(</span><span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">glmod_pred</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="m">3</span><span class="p">)</span>
<span class="nf">legend</span><span class="p">(</span><span class="s">&quot;topleft&quot;</span><span class="p">,</span> <span class="n">legend</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="s">&quot;ridge&quot;</span><span class="p">,</span> <span class="s">&quot;GLS&quot;</span><span class="p">),</span> <span class="n">lty</span> <span class="o">=</span> <span class="m">1</span><span class="p">,</span> <span class="n">col</span> <span class="o">=</span> <span class="m">2</span><span class="o">:</span><span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<img alt="../_images/reconstruct_59_0.png" src="../_images/reconstruct_59_0.png" />
</div>
</div>
<p>Since the ridge model makes no correction for the strongly correlated residuals, other than shrinking estimates, I favor the GLS model.
Converting it to <code class="docutils literal notranslate"><span class="pre">ggplot()</span></code> for a prettier plot yields the temperature reconstruction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-r notranslate"><div class="highlight"><pre><span></span><span class="nf">set_pars</span><span class="p">(</span><span class="n">dim</span> <span class="o">=</span> <span class="nf">c</span><span class="p">(</span><span class="m">8</span><span class="p">,</span> <span class="m">3</span><span class="p">))</span>
<span class="n">df</span> <span class="o">&lt;-</span> <span class="nf">data.frame</span><span class="p">(</span><span class="n">year</span> <span class="o">=</span> <span class="n">globwarm</span><span class="o">$</span><span class="n">year</span><span class="p">,</span> <span class="n">temp</span> <span class="o">=</span> <span class="n">globwarm</span><span class="o">$</span><span class="n">nhtemp</span><span class="p">,</span> <span class="n">pred</span> <span class="o">=</span> <span class="n">glmod_pred</span><span class="p">)</span>
<span class="nf">ggplot</span><span class="p">(</span><span class="n">df</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_line</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">pred</span><span class="p">),</span> <span class="n">size</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">geom_point</span><span class="p">(</span><span class="nf">aes</span><span class="p">(</span><span class="n">x</span> <span class="o">=</span> <span class="n">year</span><span class="p">,</span> <span class="n">y</span> <span class="o">=</span> <span class="n">temp</span><span class="p">),</span> <span class="n">shape</span> <span class="o">=</span> <span class="m">1</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">xlab</span><span class="p">(</span><span class="s">&quot;Year&quot;</span><span class="p">)</span> <span class="o">+</span>
  <span class="nf">ylab</span><span class="p">(</span><span class="s">&quot;Temperature (C)&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>Warning message:
“Removed 856 rows containing missing values (geom_point).”
</pre></div>
</div>
<img alt="../_images/reconstruct_61_1.png" src="../_images/reconstruct_61_1.png" />
</div>
</div>
</section>
<section id="conclusion">
<h2>Conclusion<a class="headerlink" href="#conclusion" title="Permalink to this headline">#</a></h2>
<p>I built a standard least squares regression model, a model accounting for correlated errors, and a model with additional weights after correlation adjustment.
Each of these models was tuned to have highest predictive accuracy on test data, as well as their regularized counterparts.
Though one of the regularized models had the best predictive accuracy, its underlying structure is not suited for time series data, which was validated by graphical diagnostics.
A more detailed analysis should optimize cross-validated predictive accuracy, accounting for correlation structure, and contain uncertainty estimates in the reconstruction.</p>
</section>
</section>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "adamwangdata/adamwangdata.github.io",
            ref: "main",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "r"
        },
        kernelOptions: {
            kernelName: "ir",
            path: "./stat-ml"
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'ir'</script>

              </div>
              
            </main>
            <footer class="footer-article noprint">
                
    <!-- Previous / next buttons -->
<div class='prev-next-area'>
    <a class='left-prev' id="prev-link" href="forecast.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Time Series Forecasting</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="resources.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">More Examples and Learning Resources</p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
            </footer>
        </div>
    </div>
    <div class="footer-content row">
        <footer class="col footer"><p>
  
    By Adam Wang<br/>
  
      &copy; Copyright 2022.<br/>
</p>
        </footer>
    </div>
    
</div>


      </div>
    </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/pydata-sphinx-theme.js?digest=1999514e3f237ded88cf"></script>


  </body>
</html>